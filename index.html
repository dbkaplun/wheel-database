<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <title>Wheel database</title>
    <link rel="stylesheet/less" type="text/css" href="index.less">
  </head>

  <body id="main_content_wrap">
    <h1>Wheel database <small><a href="http://wheel-size.com/calc" target="_blank">tire fitment guide</a> &bull; code, &#9733; on <a href="https://github.com/dbkaplun/wheel-database" target="_blank">Github</a></small></h1>
    <main id="wheel-database">
      <script type="text/babel">
        var WheelDatabase = React.createClass({
          getInitialState: function () {
            return {
              data: {wheels: [], lastUpdate: "never"},
              wheelOptions: {},
              selectedWheelOptions: {}
            };
          },
          componentDidMount: function () {
            var self = this;
            $.ajax({
              url: self.props.url,
              dataType: 'json',
              cache: false
            })
              .success(function (data) {
                var wheelOptionsObjs = data.wheels.reduce(function (wheelOptionsObjs, wheel) {
                  $.each(wheel, function (prop, val) {
                    if (!(prop in wheelOptionsObjs)) wheelOptionsObjs[prop] = {};
                    wheelOptionsObjs[prop][val] = true;
                  });
                  return wheelOptionsObjs;
                }, {});
                self.setState({
                  data: data,
                  wheelOptions: Object.keys(wheelOptionsObjs).reduce(function (wheelOptions, option) {
                    wheelOptions[option] = Object.keys(wheelOptionsObjs[option]);
                    return wheelOptions;
                  }, {})
                });
              })
              .error(function(xhr, status, err) { console.error(self.props.url, status, err.toString()); });
          },
          getVisibleWheels: function () {
            var self = this;
            return self.state.data.wheels.filter(function (wheel) {
              return Object.keys(self.state.selectedWheelOptions).every(function (prop) {
                var selectedWheelOption = self.state.selectedWheelOptions[prop];
                return !selectedWheelOption || wheel[prop].toString() === selectedWheelOption;
              });
            });
          },

          stopPropagation: function (evt) { evt.stopPropagation(); },
          selectChanged: function (evt) {
            var self = this;
            self.state.selectedWheelOptions[evt.target.name] = evt.target.value;
            self.setState({selectedWheelOptions: self.state.selectedWheelOptions});
          },
          render: function () {
            var Table = Reactable.Table;
            var Thead = Reactable.Thead;
            var Th = Reactable.Th;
            return (
              <div>
                <small>Last updated: {this.state.data.lastUpdate}</small>
                <Table className="table table-condensed"
                  data={this.getVisibleWheels()}
                  filterable={true}
                  sortable={true} defaultSort={{column: 'weightLbs', direction: 'asc'}}
                  itemsPerPage={100} pageButtonLimit={5}>
                  <Thead>
                    <Th column="name"><span className="name-header">Name</span></Th>
                    <Th column="mfgMethod">
                      <span className="mfgMethod-header">
                        <select name="mfgMethod" onChange={this.selectChanged} onClick={this.stopPropagation}>
                          <option value="">Manufacturing Method</option>
                          {(this.state.wheelOptions.mfgMethod || []).map(function (mfgMethod) {
                            return <option value={mfgMethod}>{mfgMethod}</option>;
                          })}
                        </select>
                      </span>
                    </Th>
                    <Th column="diameterInches">
                      <span className="diameterInches-header">
                        <select name="diameterInches" onChange={this.selectChanged} onClick={this.stopPropagation}>
                          <option value="">Diameter (in.)</option>
                          {(this.state.wheelOptions.diameterInches || []).map(function (diameterInches) {
                            return <option value={diameterInches}>{diameterInches} in.</option>;
                          })}
                        </select>
                      </span>
                    </Th>
                    <Th column="widthInches">
                      <span className="widthInches-header">
                        <select name="widthInches" onChange={this.selectChanged} onClick={this.stopPropagation}>
                          <option value="">Width (in.)</option>
                          {(this.state.wheelOptions.widthInches || []).map(function (widthInches) {
                            return <option value={widthInches}>{widthInches} in.</option>;
                          })}
                        </select>
                      </span>
                    </Th>
                    <Th column="weightLbs">
                      <span className="weightLbs-header">
                        <select name="weightLbs" onChange={this.selectChanged} onClick={this.stopPropagation}>
                          <option value="">Weight (lbs.)</option>
                          {(this.state.wheelOptions.weightLbs || []).map(function (weightLbs) {
                            return <option value={weightLbs}>{weightLbs} lbs.</option>;
                          })}
                        </select>
                      </span>
                    </Th>
                  </Thead>
                </Table>
              </div>
            );
          }
        });
        var component = React.render(<WheelDatabase url="wheels.json" />,
          document.getElementById('wheel-database')
        );
      </script>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script src="https://fb.me/react-0.14.2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/reactable/0.11.5/reactable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/less.js/2.5.3/less.min.js"></script>
  </body>
</html>
